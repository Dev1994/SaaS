version: '3.8'

services:
  # SaffaApi - connects to external observability services
  saffaapi:
    build:
      context: ./SaffaApi
      dockerfile: Dockerfile
    container_name: saffa-api
    ports:
      - "8083:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - OpenTelemetry__ServiceName=SaffaApi
      - OpenTelemetry__ServiceVersion=1.0.0
      - OpenTelemetry__OtlpEndpoint=http://otel-collector:4317
      - OpenTelemetry__JaegerEndpoint=http://jaeger:14268/api/traces
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_RESOURCE_ATTRIBUTES=service.name=SaffaApi,service.version=1.0.0
      - OTEL_LOG_LEVEL=info
      - JAEGER_ENDPOINT=http://jaeger:14268/api/traces
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./SaffaApi/data:/app/data
    networks:
      - monitoring
    restart: unless-stopped

networks:
  monitoring:
    external: true